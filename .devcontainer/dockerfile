# Dockerfile for Aether Android Development Environment
FROM ubuntu:noble

# Metadata
LABEL maintainer="jamesgbrayton@gmail.com"
LABEL description="Android development environment for Aether wallpaper project"
LABEL version="1.0"
LABEL java.version="21"
LABEL android.sdk="34"
LABEL gradle.version="8.7"
LABEL kotlin.version="1.9.23"

# Create a non-root user for development
ARG USERNAME=developer
# ARG USER_UID=1000
# ARG USER_GID=$USER_UID

# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install base system dependencies
RUN apt update && apt install -y \
    curl \
    wget \
    unzip \
    git \
    build-essential \
    ca-certificates \
    gnupg \
    software-properties-common \
    && rm -rf /var/lib/apt/lists/*

# Install additional useful tools and Android emulator dependencies
RUN apt update && apt install -y \
    vim \
    nano \
    htop \
    tree \
    libpulse0 \
    libgl1 \
    libnss3 \
    libxcomposite1 \
    libxcursor1 \
    libxi6 \
    libxtst6 \
    libasound2t64 \
    && rm -rf /var/lib/apt/lists/*

# Install Java 21 (Eclipse Temurin from Adoptium)
RUN wget -qO - https://packages.adoptium.net/artifactory/api/gpg/key/public | gpg --dearmor -o /usr/share/keyrings/adoptium-archive-keyring.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/adoptium-archive-keyring.gpg] https://packages.adoptium.net/artifactory/deb $(awk -F= '/^VERSION_CODENAME/{print$2}' /etc/os-release) main" | tee /etc/apt/sources.list.d/adoptium.list && \
    apt update && \
    apt install -y temurin-21-jdk && \
    rm -rf /var/lib/apt/lists/*

# Create a standard java-21 symlink and configure JAVA_HOME
RUN ACTUAL_JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java)))) && \
    echo "Detected Java installation: ${ACTUAL_JAVA_HOME}" && \
    ln -sfn "${ACTUAL_JAVA_HOME}" /usr/lib/jvm/java-21 && \
    echo "export JAVA_HOME=/usr/lib/jvm/java-21" >> /etc/profile.d/java.sh && \
    echo "export PATH=\$PATH:\$JAVA_HOME/bin" >> /etc/profile.d/java.sh && \
    java -version && javac -version

# Set JAVA_HOME to the symlink we created (guaranteed to exist and point to the right place)
ENV JAVA_HOME=/usr/lib/jvm/java-21
ENV PATH=$PATH:$JAVA_HOME/bin

# Set up Android SDK environment variables
ENV ANDROID_HOME=/opt/android-sdk
ENV ANDROID_SDK_ROOT=$ANDROID_HOME
ENV PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/34.0.0

# Download and install Android command line tools
# Version pinned for reproducibility - update this when needed
ENV ANDROID_CMDLINE_TOOLS_VERSION=9477386
RUN mkdir -p $ANDROID_HOME/cmdline-tools && \
    cd $ANDROID_HOME/cmdline-tools && \
    wget -q https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_CMDLINE_TOOLS_VERSION}_latest.zip && \
    unzip -q commandlinetools-linux-${ANDROID_CMDLINE_TOOLS_VERSION}_latest.zip && \
    rm commandlinetools-linux-${ANDROID_CMDLINE_TOOLS_VERSION}_latest.zip && \
    mv cmdline-tools latest

# Accept licenses and install Android SDK components
# These versions should be updated as new stable versions release
RUN yes | sdkmanager --licenses && \
    sdkmanager --install \
    "platform-tools" \
    "platforms;android-34" \
    "platforms;android-33" \
    "build-tools;34.0.0" \
    "ndk;26.1.10909125" \
    "cmake;3.22.1" && \
    sdkmanager --update

# Install emulator separately (optional - may fail in some environments)
# Emulator is not required for building Android apps, only for running them
RUN sdkmanager --install "emulator" || echo "Warning: Emulator installation failed (not critical for builds)"

# Install Gradle (version pinned for reproducibility)
ENV GRADLE_VERSION=8.7
RUN wget -q https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip && \
    unzip -q gradle-${GRADLE_VERSION}-bin.zip -d /opt && \
    rm gradle-${GRADLE_VERSION}-bin.zip && \
    ln -s /opt/gradle-${GRADLE_VERSION} /opt/gradle
ENV PATH=$PATH:/opt/gradle/bin

# Install Kotlin compiler (optional - Gradle includes it, but nice for CLI usage)
ENV KOTLIN_VERSION=1.9.23
RUN wget -q https://github.com/JetBrains/kotlin/releases/download/v${KOTLIN_VERSION}/kotlin-compiler-${KOTLIN_VERSION}.zip && \
    unzip -q kotlin-compiler-${KOTLIN_VERSION}.zip -d /opt && \
    rm kotlin-compiler-${KOTLIN_VERSION}.zip
ENV PATH=$PATH:/opt/kotlinc/bin

# Install ClaudeCode CLI (optional)
RUN curl -fsSL https://install.claude.ai | sh

# User creation and permissions are handled by the common-utils feature
# which runs after the Dockerfile is built

# Create necessary directories with appropriate permissions
RUN mkdir -p /workspace && \
    chmod 755 /workspace && \
    chmod -R 755 $ANDROID_HOME

# Note: sudo access is granted by the common-utils feature

# Set working directory (user will be set by devcontainer features)
WORKDIR /workspace

# Verify all installations (run as root before user switch)
RUN echo "=== Environment Verification ===" && \
    echo "Java:" && java -version && \
    echo "\nGradle:" && gradle -version && \
    echo "\nKotlin:" && kotlin -version && \
    echo "\nADB:" && adb version && \
    echo "\nSDK Manager:" && sdkmanager --list | head -20

# Set default shell
CMD ["/bin/bash"]

# Note: The common-utils feature will:
# 1. Create the developer user with automatic UID/GID
# 2. Set up sudo access
# 3. Install and configure zsh/oh-my-zsh
# 4. Set proper ownership of directories
