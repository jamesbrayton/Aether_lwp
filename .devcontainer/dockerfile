# Dockerfile for Aether Android Development Environment
FROM ubuntu:noble

# Metadata
LABEL maintainer="jamesgbrayton@gmail.com"
LABEL description="Android development environment for Aether wallpaper project"
LABEL version="1.0"
LABEL java.version="21"
LABEL android.sdk="34"
LABEL gradle.version="8.7"
LABEL kotlin.version="1.9.23"

# Create a non-root user for development
ARG USERNAME=developer

# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install base system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    unzip \
    git \
    build-essential \
    ca-certificates \
    gnupg \
    software-properties-common \
    && rm -rf /var/lib/apt/lists/*

# Install additional useful tools and Android emulator dependencies
RUN apt-get update && apt-get install -y \
    vim \
    nano \
    htop \
    tree \
    libpulse0 \
    libgl1 \
    libnss3 \
    libxcomposite1 \
    libxcursor1 \
    libxi6 \
    libxtst6 \
    libasound2t64 \
    && rm -rf /var/lib/apt/lists/*

# Install Python 3 and pip for MCP servers
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    && rm -rf /var/lib/apt/lists/* && \
    ln -s /usr/bin/python3 /usr/bin/python

# Install Node.js (LTS) for MCP servers and npx
RUN curl -fsSL https://deb.nodesource.com/setup_lts.x | bash - && \
    apt-get update && apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/* && \
    npm install -g npm@latest

# Install Java 21 (Eclipse Temurin from Adoptium)
RUN wget -qO - https://packages.adoptium.net/artifactory/api/gpg/key/public | gpg --dearmor -o /usr/share/keyrings/adoptium-archive-keyring.gpg && \
    echo "deb [signed-by=/usr/share/keyrings/adoptium-archive-keyring.gpg] https://packages.adoptium.net/artifactory/deb $(awk -F= '/^VERSION_CODENAME/{print$2}' /etc/os-release) main" | tee /etc/apt/sources.list.d/adoptium.list && \
    apt-get update && \
    apt-get install -y temurin-21-jdk && \
    rm -rf /var/lib/apt/lists/*

# Create a standard java-21 symlink and configure JAVA_HOME
RUN ACTUAL_JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java)))) && \
    echo "Detected Java installation: ${ACTUAL_JAVA_HOME}" && \
    ln -sfn "${ACTUAL_JAVA_HOME}" /usr/lib/jvm/java-21 && \
    echo "export JAVA_HOME=/usr/lib/jvm/java-21" >> /etc/profile.d/java.sh && \
    echo "export PATH=\$PATH:\$JAVA_HOME/bin" >> /etc/profile.d/java.sh && \
    java -version && javac -version

# Set JAVA_HOME to the symlink we created (guaranteed to exist and point to the right place)
ENV JAVA_HOME=/usr/lib/jvm/java-21
ENV PATH=$PATH:$JAVA_HOME/bin

# Set up Android SDK environment variables
ENV ANDROID_HOME=/opt/android-sdk
ENV ANDROID_SDK_ROOT=$ANDROID_HOME
ENV PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/34.0.0

# Download and install Android command line tools
# Version pinned for reproducibility - update this when needed
ENV ANDROID_CMDLINE_TOOLS_VERSION=9477386
RUN mkdir -p $ANDROID_HOME/cmdline-tools && \
    cd $ANDROID_HOME/cmdline-tools && \
    wget -q https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_CMDLINE_TOOLS_VERSION}_latest.zip && \
    unzip -q commandlinetools-linux-${ANDROID_CMDLINE_TOOLS_VERSION}_latest.zip && \
    rm commandlinetools-linux-${ANDROID_CMDLINE_TOOLS_VERSION}_latest.zip && \
    mv cmdline-tools latest

# Accept licenses and install Android SDK components
# These versions should be updated as new stable versions release
RUN yes | sdkmanager --licenses && \
    sdkmanager --install \
    "platform-tools" \
    "platforms;android-34" \
    "platforms;android-33" \
    "build-tools;34.0.0" \
    "ndk;26.1.10909125" \
    "cmake;3.22.1" && \
    sdkmanager --update

# Install emulator separately (optional - may fail in some environments)
# Emulator is not required for building Android apps, only for running them
RUN sdkmanager --install "emulator" || echo "Warning: Emulator installation failed (not critical for builds)"

# Install Gradle (version pinned for reproducibility)
ENV GRADLE_VERSION=8.7
RUN wget -q https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip && \
    unzip -q gradle-${GRADLE_VERSION}-bin.zip -d /opt && \
    rm gradle-${GRADLE_VERSION}-bin.zip && \
    ln -s /opt/gradle-${GRADLE_VERSION} /opt/gradle
ENV PATH=$PATH:/opt/gradle/bin

# Install Kotlin compiler (optional - Gradle includes it, but nice for CLI usage)
ENV KOTLIN_VERSION=1.9.23
RUN wget -q https://github.com/JetBrains/kotlin/releases/download/v${KOTLIN_VERSION}/kotlin-compiler-${KOTLIN_VERSION}.zip && \
    unzip -q kotlin-compiler-${KOTLIN_VERSION}.zip -d /opt && \
    rm kotlin-compiler-${KOTLIN_VERSION}.zip
ENV PATH=$PATH:/opt/kotlinc/bin

# Install ZSH and oh-my-zsh
RUN apt-get update && apt-get install -y \
    zsh \
    fonts-powerline \
    locales \
    sudo \
    && rm -rf /var/lib/apt/lists/* && \
    locale-gen en_US.UTF-8

# Create non-root user with sudo access
RUN useradd -m -s /bin/zsh $USERNAME && \
    echo $USERNAME ALL=\(root\) NOPASSWD:ALL > /etc/sudoers.d/$USERNAME && \
    chmod 0440 /etc/sudoers.d/$USERNAME

# Create workspace directory and set permissions
RUN mkdir -p /workspace && \
    chown -R $USERNAME:$USERNAME /home/$USERNAME /workspace $ANDROID_HOME

# Switch to developer user for oh-my-zsh installation
USER $USERNAME
WORKDIR /home/$USERNAME

# Install oh-my-zsh
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended && \
    sed -i 's/ZSH_THEME="robbyrussell"/ZSH_THEME="agnoster"/g' /home/$USERNAME/.zshrc

# Install ClaudeCode CLI as developer user
RUN curl -fsSL https://install.claude.ai | sh

# Install uv (modern Python package manager) as developer user for uvx
RUN curl -fsSL https://claude.ai/install.sh | sh

# Set up environment variables in .zshrc
RUN echo "export JAVA_HOME=$JAVA_HOME" >> /home/$USERNAME/.zshrc && \
    echo "export ANDROID_HOME=$ANDROID_HOME" >> /home/$USERNAME/.zshrc && \
    echo "export ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> /home/$USERNAME/.zshrc && \
    echo "export PATH=$PATH:\$HOME/.local/bin:\$HOME/.cargo/bin" >> /home/$USERNAME/.zshrc

# Set working directory
WORKDIR /workspace

# Verify all installations (allow failures for optional tools)
RUN echo "=== Environment Verification ===" && \
    echo "Java:" && java -version && \
    echo "\nGradle:" && gradle -version && \
    echo "\nKotlin:" && kotlin -version && \
    (echo "\nADB:" && adb version || echo "ADB verification skipped (will work at runtime)") && \
    (echo "\nSDK Manager:" && sdkmanager --list | head -20 || echo "SDK Manager verification skipped")

# Set default shell to ZSH
CMD ["/bin/zsh"]
